<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</title>
<style>
  :root{--accent:#4CAF50;--btn:#007bff}
  body{margin:0;font-family:'Noto Sans Bengali',sans-serif;background:#f5f7fa;min-height:100vh;display:flex;flex-direction:column}
  header{background:linear-gradient(45deg,var(--accent),#2E7D32);color:#fff;padding:14px;text-align:center;font-weight:700}
  .container{flex:1;padding:16px;max-width:920px;margin:16px auto 90px;box-sizing:border-box}
  .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:520px;margin:12px auto}
  .balance{font-size:22px;font-weight:700;color:#222;text-align:center}
  .points{font-size:14px;color:#444;text-align:center;margin-top:6px}
  .small{font-size:13px;color:#666}
  input,select,textarea{width:100%;padding:10px;margin-top:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  .btn{background:linear-gradient(45deg,var(--btn),#0062cc);color:#fff;padding:12px;border:none;border-radius:8px;cursor:pointer;width:100%;font-size:16px;margin-top:12px}
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;display:flex;background:#fff;border-top:1px solid #ddd;z-index:999}
  .bottom-nav button{flex:1;padding:10px;background:none;border:none;font-size:14px;cursor:pointer}
  .bottom-nav button.active{color:var(--accent);font-weight:700}
  .history-item{background:#fafafa;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:8px}
  .note{font-size:13px;color:#666;margin-top:8px}
  .muted{color:#888;font-size:13px}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{width:94%;max-width:720px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
  .modal-header{padding:10px 14px;background:#f7f7f7;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .modal-body{background:#000;color:#fff;height:60vh;display:flex;align-items:center;justify-content:center}
  .modal-footer{padding:10px 14px;background:#fff;border-top:1px solid #eee;display:flex;gap:8px;align-items:center}
  .countdown{font-weight:700}
  .claim-btn{background:linear-gradient(45deg,#28a745,#218838);color:#fff;padding:10px;border-radius:8px;border:none;cursor:pointer}
  .claim-btn[disabled]{opacity:0.6;cursor:not-allowed}
  .close-btn{background:none;border:none;font-size:18px;cursor:pointer}
  iframe.ad-iframe{width:100%;height:100%;border:0}
</style>

<!-- Monetag SDK (your provided tag) -->
<script src="//libtl.com/sdk.js" data-zone="9678549" data-sdk="show_9678549"></script>

</head>
<body>

<header id="headerUser">üë§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</header>

<div class="container">
  <!-- HOME -->
  <section id="home" class="card">
    <div class="balance"><span id="balanceEl">üí∞ ‡ß¶.‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</span></div>
    <div class="points" id="pointsEl">‚≠ê ‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</div>
    <p class="small" style="text-align:center;margin-top:10px">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‚Äî ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ì ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>
  </section>

  <!-- EARN -->
  <section id="earn" class="card" style="display:none">
    <h3>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º</h3>
    <p class="small">‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú <strong id="adsCount">‡ß¶</strong> ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡¶®</p>
    <p class="small">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°: <strong>‡ßß‡ß´ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</strong> ‚Äî ‡ßß‡ß¶‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü = ‡ßß ‡¶ü‡¶æ‡¶ï‡¶æ</p>
    <p class="small">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: <strong id="earnPoints">‡ß¶</strong> ‚≠ê</p>
    <p class="small">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: <strong id="earnBalance">‡ß¶.‡ß¶‡ß¶</strong> ‡¶ü‡¶æ‡¶ï‡¶æ</p>

    <button id="watchAdBtn" class="btn">üì∫ Watch Ad</button>

    <div id="adHint" style="margin-top:14px;text-align:center">
      <div class="muted">Monetag ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° modal/iframe-‡¶è ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá ‚Äî ‡¶Ø‡¶¶‡¶ø blocked ‡¶π‡ßü, ‡¶§‡¶ñ‡¶® ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§</div>
    </div>
  </section>

  <!-- WITHDRAW -->
  <section id="withdraw" class="card" style="display:none">
    <h3>‡¶ü‡¶æ‡¶ï‡¶æ ‡¶§‡ßã‡¶≤‡¶æ (Withdraw)</h3>
    <p class="small">‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ <strong>‡ßß‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</strong> ‡¶π‡¶≤‡ßá Withdraw ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
    <p class="small">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏: <strong id="withdrawBalance">‡ß¶.‡ß¶‡ß¶</strong> ‡¶ü‡¶æ‡¶ï‡¶æ</p>

    <label class="small">‡¶®‡¶æ‡¶Æ</label>
    <input id="w_name" type="text" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" />

    <label class="small">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
    <input id="w_mobile" type="text" placeholder="‡ß¶‡ßßXXXXXXXXX" />

    <label class="small">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</label>
    <input type="text" value="‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂" disabled style="background:#f1f1f1" />

    <label class="small">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
    <input id="w_amount" type="number" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 100" />

    <div class="note">Withdraw ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü Telegram-‡¶è ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶æ‡¶á ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç Firebase-‡¶è <code>withdrawRequests</code> ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá‡•§</div>
    <button class="btn" onclick="submitWithdraw()">üí∏ Withdraw ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
  </section>

  <!-- HISTORY -->
  <section id="history" class="card" style="display:none">
    <h3>Withdraw History</h3>
    <div id="historyList" class="small"><p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
  </section>

  <!-- REFER -->
  <section id="refer" class="card" style="display:none">
    <h3>Refer & Earn</h3>
    <p class="small">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá: <strong>‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ</strong></p>
    <p class="small">‡¶Ü‡¶™‡¶®‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®: <strong id="refCount">0</strong> ‚Äî ‡¶Ü‡ßü (‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø): <strong id="refEarnings">0</strong> ‡¶ü‡¶æ‡¶ï‡¶æ</p>
    <p class="small">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï (‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®):</p>
    <input id="refLink" type="text" readonly />
    <div class="note">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡ßü‡ßá ‡¶ï‡ßá‡¶â ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶≤‡ßá referral ‡¶®‡ßã‡¶°‡ßá ‡¶≤‡¶ó ‡¶π‡¶¨‡ßá; ‡¶ï‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶π‡¶¨‡ßá‡•§</div>
  </section>
</div>

<!-- bottom nav -->
<div class="bottom-nav">
  <button class="active" onclick="show('home', this)">üè† Home</button>
  <button onclick="show('earn', this)">üíº Earn</button>
  <button onclick="show('withdraw', this)">üí∏ Withdraw</button>
  <button onclick="show('history', this)">üìú History</button>
  <button onclick="show('refer', this)">üë• Refer</button>
</div>

<!-- Modal for ad -->
<div id="adModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog">
    <div class="modal-header">
      <strong>Advertisement</strong>
      <button class="close-btn" onclick="closeAdModal()" title="Close">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody">
      <iframe id="adIframe" class="ad-iframe" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
    </div>
    <div class="modal-footer">
      <div class="muted">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®: <span class="countdown" id="countdown">20</span>s</div>
      <button id="claimBtn" class="claim-btn" disabled>Claim Reward</button>
    </div>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
/* ---------------- CONFIG (EMBEDDED) ---------------- */
const MONETAG_LINK = "https://otieu.com/4/9683674";
const MONETAG_ZONE_ID = "9678549";

const BOT_TOKEN = "8246874186:AAGeNY1eACn8HOahy-Rog3jSwe8EKNBgl8w";
const CHAT_ID  = "7712532566"; // admin telegram id

/* ---------------- Firebase imports & config ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getDatabase,
  ref,
  push,
  set,
  get,
  child,
  onValue
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlXsiLG6AfOBdBY24H9yMGDbbSyUnCDSs",
  authDomain: "earnapp-edce1.firebaseapp.com",
  databaseURL: "https://earnapp-edce1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "earnapp-edce1",
  storageBucket: "earnapp-edce1.firebasestorage.app",
  messagingSenderId: "257375665873",
  appId: "1:257375665873:web:ffadc9ec07d5a44aac8ff0",
  measurementId: "G-KB302QN67L"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- State & user init ---------------- */
let points = parseInt(localStorage.getItem('points')) || 0;
let adsWatched = parseInt(localStorage.getItem('adsWatched')) || 0;
let refCount = 0;

let userName = localStorage.getItem('app_user_name') || '';
let userId = localStorage.getItem('app_user_id') || '';

// Telegram WebApp detection
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
function getTelegramIdIfExists(){
  try {
    if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id){
      return String(tg.initDataUnsafe.user.id);
    }
  } catch(e){}
  return null;
}

function generateLocalId(){
  return 'u_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*9000+1000);
}

async function initUser(){
  if(!userName){
    userName = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):") || "‡¶Ö‡¶§‡¶ø‡¶•‡¶ø";
    localStorage.setItem('app_user_name', userName);
  }

  // prefer Telegram id if available (WebApp), else use stored local id or generate
  const tId = getTelegramIdIfExists();
  if(tId){
    userId = 'tg_' + tId; // prefix so it's obvious it's telegram id
    localStorage.setItem('app_user_id', userId);
  } else {
    userId = localStorage.getItem('app_user_id') || generateLocalId();
    localStorage.setItem('app_user_id', userId);
  }

  // record referral if ?ref= is present (do NOT overwrite userId)
  const urlParams = new URLSearchParams(window.location.search);
  const refParam = urlParams.get('ref');
  if(refParam && refParam !== userId){
    try {
      const r = push(ref(db, 'referrals'));
      await set(r, { refBy: refParam, referred: userId, time: new Date().toISOString() });
      // no automatic credit here
    } catch(e){
      console.warn('ref save fail', e);
    }
  }

  document.getElementById('headerUser').innerText = `üë§ ${userName}`;
  document.getElementById('refLink').value = location.origin + location.pathname + "?ref=" + encodeURIComponent(userId);

  // load referral count
  loadRefCount();
}
initUser();

/* ---------------- UI update ---------------- */
function updateUI(){
  const balance = (points/100).toFixed(2);
  document.getElementById('balanceEl').innerText = `üí∞ ${balance} ‡¶ü‡¶æ‡¶ï‡¶æ`;
  document.getElementById('pointsEl').innerText = `‚≠ê ${points} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü`;
  document.getElementById('adsCount').innerText = adsWatched;
  document.getElementById('earnPoints').innerText = points;
  document.getElementById('earnBalance').innerText = balance;
  document.getElementById('withdrawBalance').innerText = balance;
  document.getElementById('refCount').innerText = refCount;
  document.getElementById('refEarnings').innerText = (refCount * 5);
}
updateUI();

/* ---------------- Tabs ---------------- */
function show(id, btn){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(id === 'history') loadHistory();
}
window.show = show;

/* ---------------- Referral loader ---------------- */
async function loadRefCount(){
  try {
    const snap = await get(child(ref(db), 'referrals'));
    if(!snap.exists()){
      refCount = 0;
    } else {
      const data = snap.val();
      // count referrals where refBy === userId
      refCount = Object.keys(data).map(k => data[k]).filter(r => r.refBy === userId).length;
    }
    updateUI();
  } catch(e){
    console.warn('refcount load err', e);
    refCount = 0;
    updateUI();
  }
}

/* ---------------- Monetag availability check ---------------- */
let monetagReady = false;
function checkMonetagReady(){
  // SDK likely exposes function show_{zone} (data-sdk value). For your zone id 9678549 name is show_9678549
  if(typeof window.show_9678549 === 'function') return true;
  // some SDKs attach differently ‚Äî try checking window.Monetag or libtl
  if(window.libtl || window.Monetag) return true;
  return false;
}
monetagReady = checkMonetagReady();

/* If SDK isn't ready yet, poll for a short period */
let monetagPollCount = 0;
const monetagPoll = setInterval(()=>{
  monetagPollCount++;
  monetagReady = checkMonetagReady();
  if(monetagReady || monetagPollCount > 10) clearInterval(monetagPoll);
}, 500);

/* ---------------- Rewarded Ad modal logic ---------------- */
const adModal = document.getElementById('adModal');
const adIframe = document.getElementById('adIframe');
const countdownEl = document.getElementById('countdown');
const claimBtn = document.getElementById('claimBtn');
let countdownTimer = null;
let countdownSeconds = 20;
let adOpenedViaNewTab = false;

function openAdModal(){
  adModal.style.display = 'flex';
  adOpenedViaNewTab = false;
  claimBtn.disabled = true;
  countdownSeconds = 20;
  countdownEl.innerText = countdownSeconds;
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    countdownSeconds--;
    countdownEl.innerText = countdownSeconds;
    if(countdownSeconds <= 0){
      clearInterval(countdownTimer);
      claimBtn.disabled = false;
    }
  }, 1000);
  // try Monetag SDK function first (in-case it wants to open its own modal)
  if(typeof window.show_9678549 === 'function'){
    try {
      window.show_9678549(); // Monetag SDK handles its own UI if present
      // also load fallback iframe content so modal not blank
      adIframe.src = MONETAG_LINK;
    } catch(e){
      adIframe.src = MONETAG_LINK;
    }
  } else {
    // load iframe (may be blocked by X-Frame-Options)
    adIframe.src = MONETAG_LINK;
    // set onerror to fallback open new tab
    adIframe.onerror = function(){
      if(!adOpenedViaNewTab){
        adOpenedViaNewTab = true;
        window.open(MONETAG_LINK, '_blank');
        const mb = document.getElementById('modalBody');
        mb.innerHTML = '<div style="padding:10px;color:#000;background:#fff;border-radius:6px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßá‡¶õ‡ßá ‚Äî ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá <strong>Claim Reward</strong> ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§</div>';
      }
    };
  }
}

function closeAdModal(){
  adModal.style.display = 'none';
  clearInterval(countdownTimer);
  adIframe.src = 'about:blank';
  // restore iframe in modalBody if it was replaced
  const mb = document.getElementById('modalBody');
  if(!mb.querySelector('#adIframe')){
    mb.innerHTML = '';
    mb.appendChild(adIframe);
  }
}

/* Claim reward */
async function claimReward(){
  if(claimBtn.disabled) return;
  const earnedPoints = 15;
  points += earnedPoints;
  adsWatched += 1;
  localStorage.setItem('points', points);
  localStorage.setItem('adsWatched', adsWatched);
  updateUI();

  // write audit record to Firebase
  try {
    const aRef = push(ref(db, 'adsHistory'));
    await set(aRef, { userId, userName, points: earnedPoints, ts: new Date().toISOString() });
  } catch(e){ console.warn('adsHistory save failed', e); }

  // notify admin via Telegram
  const text = `üèÜ Earn Complete\nUser: ${userName}\nUserID: ${userId}\nPoints Earned: +${earnedPoints}\nTotal Points (client): ${points}`;
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(text)}`)
    .catch(e=>console.warn('Telegram earn notify failed', e));

  closeAdModal();
  alert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®! (‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶´‡ßá‡¶∏‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá)');
}

/* ---------------- Wire Watch Ad button (with Monetag ready check) ---------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('watchAdBtn');
  btn.addEventListener('click', async ()=>{
    // ensure SDK has had time to initialize ‚Äî if not ready, still open modal with iframe fallback
    monetagReady = checkMonetagReady();
    if(monetagReady){
      // if SDK provides show_9678549 it might handle UI internally; still open modal as visual container
      openAdModal();
    } else {
      // not ready: open modal with iframe fallback (or open new tab)
      openAdModal();
    }
  });

  // claim button listener
  claimBtn.addEventListener('click', claimReward);

  // close on ESC
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAdModal(); });
});

/* ---------------- Withdraw submit ---------------- */
window.submitWithdraw = async function(){
  const name = document.getElementById('w_name').value.trim();
  const mobile = document.getElementById('w_mobile').value.trim();
  const amount = parseInt(document.getElementById('w_amount').value, 10);
  const currentBalance = Math.floor(points/100);

  if(!name || !mobile || isNaN(amount) || amount <= 0){
    alert('‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    return;
  }
  if(currentBalance < 100){
    alert('Withdraw ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßß‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§');
    return;
  }
  if(amount > currentBalance){
    alert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶§‡ßÅ‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§');
    return;
  }
  if(amount < 100){
    alert('‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ßß‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶®‡•§');
    return;
  }

  const now = new Date();
  const entry = {
    userId,
    userName,
    name,
    mobile,
    method: 'bKash',
    amount,
    status: 'pending',
    timestamp: now.toISOString(),
    dateString: now.toLocaleString('bn-BD', { timeZone: 'Asia/Dhaka' })
  };

  try {
    const wRef = push(ref(db, 'withdrawRequests'));
    await set(wRef, entry);

    // Telegram notify
    const message = `üì¢ ‡¶®‡¶§‡ßÅ‡¶® Withdraw ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü!\n‡¶®‡¶æ‡¶Æ: ${name}\n‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${userName}\n‡¶Ü‡¶á‡¶°‡¶ø: ${userId}\n‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: bKash\n‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞: ${mobile}\n‡¶ü‡¶æ‡¶ï‡¶æ: ${amount} ‡¶ü‡¶æ‡¶ï‡¶æ\n‡¶∏‡¶Æ‡ßü: ${entry.dateString}`;
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`)
      .catch(e=>console.warn('Telegram withdraw notify failed', e));

    // deduct local points
    const deductPoints = amount * 100;
    points = Math.max(0, points - deductPoints);
    localStorage.setItem('points', points);
    updateUI();

    alert('‚úÖ Withdraw ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡•§');
    document.getElementById('w_name').value = '';
    document.getElementById('w_mobile').value = '';
    document.getElementById('w_amount').value = '';

  } catch(err){
    console.error('withdraw error', err);
    alert('‚ùå ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚Äî ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
  }
};

/* ---------------- Load history (user-specific) ---------------- */
async function loadHistory(){
  const out = document.getElementById('historyList');
  out.innerHTML = '<p class="small">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
  try {
    const snap = await get(child(ref(db), 'withdrawRequests'));
    if(!snap.exists()){
      out.innerHTML = '<p class="small">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>';
      return;
    }
    const data = snap.val();
    const arr = Object.keys(data).map(k=>({ id:k, ...data[k] }))
                .filter(x=>x.userId === userId)
                .sort((a,b)=> b.timestamp.localeCompare(a.timestamp));
    if(arr.length === 0){
      out.innerHTML = '<p class="small">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã Withdraw ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</p>';
      return;
    }
    out.innerHTML = '';
    arr.forEach(h=>{
      const d = document.createElement('div');
      d.className = 'history-item';
      d.innerHTML = `<div><strong>${h.amount} ‡¶ü‡¶æ‡¶ï‡¶æ</strong> ‚Äî <span class="small">${h.dateString}</span></div>
                     <div class="small">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: ${h.method} ‚Äî ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞: ${h.mobile}</div>
                     <div class="small">Status: ${h.status}</div>`;
      out.appendChild(d);
    });
  } catch(e){
    console.error('history load', e);
    out.innerHTML = '<p class="small">‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</p>';
  }
}
window.loadHistory = loadHistory;

/* ---------------- Live update listener ---------------- */
onValue(ref(db, 'withdrawRequests'), snapshot=>{
  if(document.getElementById('history').style.display === 'block') loadHistory();
});

/* ---------------- initial UI (safe) ---------------- */
updateUI();
</script>
</body>
</html>